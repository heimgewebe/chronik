class: python-service
tasks:
  smoke: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
# Neuer Name (CHRONIK_TOKEN), aber Helper erwartet derzeit noch LEITSTAND_TOKEN.
# Wir spiegeln beide, damit Client und Server denselben Key sehen.
    export CHRONIK_TOKEN="${CHRONIK_TOKEN:-dev}"
export LEITSTAND_TOKEN="${LEITSTAND_TOKEN:-$CHRONIK_TOKEN}"
python3 - <<'PY'
import httpx
from app import app
from tools.hauski_ingest import ingest_event

# Im Testcode existiert ein SyncASGITransport, der ASGI in den sync Client adaptiert.
try:
    from tests.test_ingest_client import SyncASGITransport
except ImportError as exc:
    raise SystemExit(f"SyncASGITransport helper not found: {exc}")

transport = SyncASGITransport(app=app)

result = ingest_event(
    "example.com", {"event": "test", "status": "ok"}, url="http://test", transport=transport
)
print(result)
PY
  guard: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
    export PYTHONPATH="${PYTHONPATH:-.}:."
    python3 -m pytest
  metrics: |
    set -euxo pipefail
    if [ -x scripts/wgx-metrics-snapshot.sh ]; then
      scripts/wgx-metrics-snapshot.sh --json
    else
      echo "[wgx.metrics] scripts/wgx-metrics-snapshot.sh fehlt, Ã¼bersprungen"
    fi
  snapshot: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
    python3 -m pytest -q
