class: python-service
tasks:
  smoke: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
    # Neuer Name (CHRONIK_TOKEN)
    export CHRONIK_TOKEN="${CHRONIK_TOKEN:-dev}"
    python3 - <<'PY'
    from fastapi.testclient import TestClient
    from app import app
    from tools.hauski_ingest import ingest_event

    # Use TestClient's transport for hermetic testing
    client = TestClient(app)

    result = ingest_event(
        "example.com",
        {"event": "test", "status": "ok"},
        url="http://test",
        transport=client._transport,
    )
    print(result)
    PY
  guard: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
    export PYTHONPATH="${PYTHONPATH:-.}:."
    python3 -m pytest
  metrics: |
    set -euxo pipefail
    if [ -x scripts/wgx-metrics-snapshot.sh ]; then
      scripts/wgx-metrics-snapshot.sh --json
    else
      echo "[wgx.metrics] scripts/wgx-metrics-snapshot.sh fehlt, Ã¼bersprungen"
    fi
  snapshot: |
    set -euxo pipefail
    bash scripts/setup-venv.sh
    . .venv/bin/activate
    python3 -m pytest -q
